(function(global,factory){if('function'==typeof define&&define.amd)define(['module','exports','lodash/map','lodash/isEmpty','lodash/isFunction','lodash/isString','lodash/isNumber','lodash/isBoolean','lodash/last','lodash/isDate','lodash/isNull','lodash/forIn','lodash/isArray','lodash/includes','lodash/uniqueId','@djforth/ajax-es6-fp/fetch','moment-strftime','immutable'],factory);else if('undefined'!=typeof exports)factory(module,exports,require('lodash/map'),require('lodash/isEmpty'),require('lodash/isFunction'),require('lodash/isString'),require('lodash/isNumber'),require('lodash/isBoolean'),require('lodash/last'),require('lodash/isDate'),require('lodash/isNull'),require('lodash/forIn'),require('lodash/isArray'),require('lodash/includes'),require('lodash/uniqueId'),require('@djforth/ajax-es6-fp/fetch'),require('moment-strftime'),require('immutable'));else{var mod={exports:{}};factory(mod,mod.exports,global.map,global.isEmpty,global.isFunction,global.isString,global.isNumber,global.isBoolean,global.last,global.isDate,global.isNull,global.forIn,global.isArray,global.includes,global.uniqueId,global.fetch,global.momentStrftime,global.immutable),global.dataManager=mod.exports}})(this,function(module,exports,_map2,_isEmpty2,_isFunction2,_isString2,_isNumber2,_isBoolean2,_last2,_isDate2,_isNull2,_forIn2,_isArray2,_includes2,_uniqueId2,_fetch,_momentStrftime,_immutable){'use strict';function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}Object.defineProperty(exports,'__esModule',{value:!0});var _map3=_interopRequireDefault(_map2),_isEmpty3=_interopRequireDefault(_isEmpty2),_isFunction3=_interopRequireDefault(_isFunction2),_isString3=_interopRequireDefault(_isString2),_isNumber3=_interopRequireDefault(_isNumber2),_isBoolean3=_interopRequireDefault(_isBoolean2),_last3=_interopRequireDefault(_last2),_isDate3=_interopRequireDefault(_isDate2),_isNull3=_interopRequireDefault(_isNull2),_forIn3=_interopRequireDefault(_forIn2),_isArray3=_interopRequireDefault(_isArray2),_includes3=_interopRequireDefault(_includes2),_uniqueId3=_interopRequireDefault(_uniqueId2),_fetch2=_interopRequireDefault(_fetch),_momentStrftime2=_interopRequireDefault(_momentStrftime),_immutable2=_interopRequireDefault(_immutable),_createClass=function(){function defineProperties(target,props){for(var descriptor,i=0;i<props.length;i++)descriptor=props[i],descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),addIds=function(data){return data.map(function(d){return d.has('id')?d:d.set('id',(0,_uniqueId3.default)())})},mergeList=function(current,merge){return current.map(function(data){var merger=merge.find(function(m){return data.get('id')===m.get('id')});return merger?data.merge(merger):data})},unionLists=function(current,update){var ids=current.map(function(d){return d.get('id')}).toArray(),data=addIds(update),merge=data.filter(function(d){return(0,_includes3.default)(ids,d.get('id'))}),adding=data.filter(function(d){return!(0,_includes3.default)(ids,d.get('id'))}),newData=mergeList(current,merge);return newData.concat(adding)},DataManager=function(){function DataManager(defaults){_classCallCheck(this,DataManager),this.data=null,this.history=[],this.keys=null,this.cid=(0,_uniqueId3.default)('c'),this.defaults=defaults;for(var _len=arguments.length,args=Array(1<_len?_len-1:0),_key=1;_key<_len;_key++)args[_key-1]=arguments[_key];(0,_isArray3.default)(args[0])&&this.add(args.shift());var f=(0,_last3.default)(args),fet=!!(0,_isBoolean3.default)(f)&&args.pop();0<args.length?this.init(args[0],fet):this.init(fet)}return _createClass(DataManager,[{key:'add',value:function(d){var _this=this;this.addToHistory();var newData,m=this.manageDates((0,_isArray3.default)(d)?d:[d]),adding=_immutable2.default.fromJS(m);newData=this.data?unionLists(this.data,adding):adding,this.data=newData.map(function(dta){return _this.addDefaults(dta)})}},{key:'addDates',value:function(item,keys){return(0,_forIn3.default)(item,function(v,k){if((0,_includes3.default)(keys,k)&&!(0,_isNull3.default)(item)){var dateFmt=(0,_momentStrftime2.default)(v);item[k]=dateFmt.toDate();item[k+'Df']=dateFmt}}),item}},{key:'addDefaults',value:function(d){var def=d;return this.defaults&&(0,_forIn3.default)(this.defaults,function(v,k){return def=d.set(k,v)}),def}},{key:'addId',value:function(){this.addToHistory(),this.data=this.data.map(function(d){var dta=d;return d.has('id')||(dta=d.set('id',(0,_uniqueId3.default)())),dta})}},{key:'addToHistory',value:function(){this.data&&this.history.push(this.data)}},{key:'dateSearch',value:function(key,st,fn){if(!((0,_isDate3.default)(st)&&(0,_isDate3.default)(fn)))throw new Error('Start and finish must be dates');return this.data.filter(function(d){var item=d.get(key);return item>st&&item<fn})}},{key:'clearAll',value:function(){this.addToHistory(),this.data=null}}]),_createClass(DataManager,[{key:'dataCheck',value:function(d){return this.data&&d||(this.data?this.warn('Updates are not defined'):this.warn('No Data to update'),!1)}},{key:'formatDate',value:function(id,key){var fmt=2<arguments.length&&void 0!==arguments[2]?arguments[2]:'%d/%m/%Y',item=(0,_isNumber3.default)(id)?this.findById(id):id,df=item.get(key+'Df');return df?df.strftime(fmt):''}},{key:'getDateKeys',value:function(item){var dateRegExp=new RegExp(/^\s*(\d{4})-(\d{2})-(\d{2})+!?(\s(\d{2}):(\d{2})|\s(\d{2}):(\d{2}):(\d+))?$/),dateKeys=[];return(0,_forIn3.default)(item,function(v,k){if((0,_isString3.default)(v)){var dateMatch=v.match(dateRegExp);(0,_isNull3.default)(dateMatch)||dateKeys.push(k)}}),dateKeys}},{key:'each',value:function(){var func=0>=arguments.length?void 0:arguments[0],context=1>=arguments.length?void 0:arguments[1];if(!(0,_isFunction3.default)(func))throw new Error('Must be a function');if((0,_isNull3.default)(this.data))throw new Error('Please add data to iterating');context?this.data.forEach(func.bind(context)):this.data.forEach(func)}},{key:'fetch',value:function(){var _this2=this,clear=1<arguments.length&&void 0!==arguments[1]&&arguments[1];clear&&this.clearAll();var uri=(0,_isFunction3.default)(this.url)?this.url():this.url,fetchData=(0,_fetch2.default)(uri);return fetchData.then(function(data){return _this2.add(data),data}).catch(function(err){throw new Error(err)})}},{key:'findById',value:function(id){return this.data.find(function(d){return d.get('id')===id})}},{key:'findByIndex',value:function(i){return this.data.get(i)}},{key:'getAll',value:function(){return this.data}},{key:'getKeys',value:function(){var hard=0<arguments.length&&void 0!==arguments[0]&&arguments[0];if(0<this.data.size&&(!this.keys||hard)){var item=this.data.first(),k=item.keySeq();this.keys=k.toJS()}return this.keys}},{key:'init',value:function(fet){fet&&this.fetch()}},{key:'manageDates',value:function(items){var _this3=this,dateKeys=[],i=0;do dateKeys=this.getDateKeys(items[i]),i++;while((0,_isEmpty3.default)(dateKeys)&&20>i);return(0,_isEmpty3.default)(dateKeys)?items:(0,_map3.default)(items,function(item){var keys=_this3.getDateKeys(item);return _this3.addDates(item,keys)})}},{key:'remove',value:function(id){var del=this.findById(id);if(del){var i=this.data.indexOf(del);return this.data=this.data.delete(i),del}return this.warn('Can\'t find item'),null}},{key:'resetHard',value:function(i){this.resetTo(i),this.history=this.history.splice(0,i)}},{key:'resetTo',value:function(i){this.data=this.history[i]}},{key:'search',value:function(val,keys){if(this.dataCheck(val)){var regex=new RegExp(val,'i');return this.data.filter(function(d){if(1<keys.length){var values=d.filter(function(v,k){return(0,_includes3.default)(keys,k)}),all=values.valueSeq().toJS().join(' ');return-1<all.search(regex)}var key=keys[0];if(d.has(key)){var value=d.get(key);return-1<(value+'').search(regex)}return!1})}return this.data}},{key:'sort',value:function(key){var _this4=this,asc=1<arguments.length&&void 0!==arguments[1]?arguments[1]:!0;return this.data.sort(function(a,b){var itemA=asc?a.get(key):b.get(key),itemB=asc?b.get(key):a.get(key);return(0,_isString3.default)(itemA)&&(0,_isString3.default)(itemB)&&(itemA=itemA.toLowerCase(),itemB=itemB.toLowerCase()),_this4.sortAlgorithm(itemA,itemB)})}},{key:'sortAlgorithm',value:function(itemA,itemB){return itemA<itemB?-1:itemA>itemB?1:0}},{key:'update',value:function(id,updates){var _this5=this,sync=2<arguments.length&&void 0!==arguments[2]&&arguments[2];return this.dataCheck(updates)&&(this.addToHistory(),this.data=this.data.map(function(d){return d.get('id')+''===id+''?_this5.updateItem(d,updates):d}),sync&&this.sync(id)),null}},{key:'updateItem',value:function(item,data){var update;return(0,_forIn3.default)(data,function(v,k){return update=item.set(k,v)}),update}},{key:'updateAll',value:function(updates){var _this6=this;return this.dataCheck(updates)&&(this.addToHistory(),this.data=this.data.map(function(d){return _this6.updateItem(d,updates)})),null}},{key:'warn',value:function(warning){console.warn&&console.warn(warning)}}]),DataManager}();exports.default=DataManager,module.exports=exports['default']});
